---
title: "Combine-climate-lite-scripts"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: html_document
abstract: This script combines all scripts previously run under CCRP's Climate Lite protocol for Resource Stewardship Strategies (RSS). 
---

NOTE: If you have trouble with packages loading from renv, go into your .Rprofile file and comment out the line ```source("renv/activate.R)```
Then restart R and re-run from your general package library (R will do this automatically upon restart if the above line is commented out). If you want to check what library R is accessing, type ```.libPaths()``` into your console. 

##

```{r setup, include=FALSE}

knitr::opts_chunk$set(
  echo = FALSE, 
  collapse = TRUE,
  warning = TRUE, # set to FALSE when done
  message = TRUE # set to FALSE when done
)

#renv::init() Only needs to be run 1x when project is initiated. No one should ever have to run this line again. 

#renv::restore() # This line will restore packages to the versions recorded in the lockfile. Collaborators can use this command to keep their packages current. This line should be run once a week.  

#renv::update(exclude = "WaterBalance") # This line should be run once a week by whoever is regularly using this script. The first time running this line, you might need to follow directions to create a Personal Access Token with GitHub. Simply follow directions printed in the console. If you run into trouble, contact Annie Kellner Dillon at anne_dillon@nps.gov 

# renv::snapshot() # This command takes a snapshot of the packages in their current state and records it in the lockfile. Renv will perform this task periodically. If a manual snapshot is desired, use this command to manually update the lockfile.

#Install WaterBalance package from Github repository
# install_github("CCRP-Adaptation/WaterBalance", subdir="WaterBalance")
#Install CFT
# remotes::install_github("earthlab/cft@*release",force=TRUE)

# packages = c("ggplot2","grid","cowplot","reshape2","ncdf4","WriteXLS","data.table","RColorBrewer","ggrepel","lubridate","dplyr","forcats","openxlsx","sf","raster","rgdal","R.utils","tmap","tmaptools","gridExtra","SPEI","tidyr","tibble","sp",
#   "skimr")
# install.packages(packages)

library(here); library(plyr); # Use here::here when package lubridate is used
library(plotrix); library(zoo); library(ggplot2); library(grid); library(cowplot); library(reshape2); library(raster); library(ncdf4); library(reshape2); library(WriteXLS); library(data.table); library(RColorBrewer); library(ggrepel); library(lubridate); library(dplyr); library(forcats); library(openxlsx); library("WaterBalance"); library(sf); library(raster); library(rgdal); library(R.utils); library(tmap); library(tmaptools); library(ggmap); library(ggspatial);
library(gridExtra); library(SPEI); library(tidyr); library(tibble); library(sp); library(skimr); library(cft); library(stringr); library(ggpubr); library(lemon)


```


There are two code chunks in which the RCF user should enter information that is park-specific. The first chunk contains inputs that are often changed (i.e., with each new park). The second chunk contains user inputs that are *rarely* changed (i.e., project lead has requested a change).

**First user input chunk (please enter park-specific information):**

```{r user-inputs-1}

rm(list = ls())

# -------------- Input site information -------------------------------------- #

SiteID = "VALL" 
# Lat = 40.44039704 # Can manually input lat/lon, otherwise run get_site_info.R
# Lon = -111.7093944

# --------------- Input local folder information ----------------------------- #

# When this document has finished running, the files will be copied to a local directory and all newly created files (e.g., figures) will be deleted from the repo

project_root_dir <- 'C:/Users/achildress/Documents/Git-repos/CCRP_Climate_Futures_v1.0' # local directory where your repo is stored
local_rss_dir <- 'C:/Users/achildress/Documents/RCF_Testing/' # local directory where you want this repo copied. Should be something like 'C:/Users/adillon/Documents/RSS/'. Next lines create folder for park
local_rss_dir <- paste0(local_rss_dir,SiteID)

if(dir.exists(local_rss_dir) == FALSE){
  dir.create(local_rss_dir)
}

OutDir = paste0('./PARK/',SiteID,"/") # for .csv's
if(dir.exists(OutDir) == FALSE){
  dir.create(OutDir)
}

DataDir = paste0(OutDir,'input-data/') # for .csv's
if(dir.exists(DataDir) == FALSE){
  dir.create(DataDir)
}

```

# Site Info
The get_params.R script extracts site parameters for inputting into Dave Thoma's Water Balance model (see 'Daily_WB_batch_v2.R'). The create_site_maps.R script creates a suite of maps from which the project lead can select the most appropriate for use with the RSS Powerpoint presentation. Maps output into the './figures/maps' folder. 
```{r site-info, message=FALSE, warning=FALSE, echo = FALSE, results=HIDE}

source(here::here("scripts", "Misc", "get_site_info.R")) # Extract local inputs; seconds to run

source(here::here("scripts", "Misc", "create_site_maps.R")) # Create site maps
```

**Second user input chunk (information that should only be changed when directly specified)**

```{r user-inputs-2}

CFs_all <- c("Warm Wet", "Hot Wet", "Central", "Warm Dry", "Hot Dry")

centroids_csv <- "Y" #Switch for using Tercek csvs or downloading own data

# --------- Information for Climate Futures Analyses (MACA) ------------------ #

# Specify parameters:

Yr = 2040 #Central year
Range = 30  #Number of years to summarize (should be at least 30)
BasePeriod = "1979-2012"
rollLen = 10 #rolling mean length for timeseries plots

# Threshold percentages for defining Climate futures. Default low/high:  0.25, 0.75
CFLow = 0.25     
CFHigh = 0.75

QuantileLow = 0.05   #Quantiles for temperature threshold calculations
QuantileHigh = 0.95

HotTemp = 95
ColdTemp = 32
PrecipThreshold = 0.05

# ------------ Information for drought analyses ------------------------ #

## SPEI variables

SPEI_per<-6 # This is the value for the period SPEI is aggregated. 6-months is standard but could change if want. 
truncation<- -.5 # SPEI value, under which drought events are considered
SPEI_start <- 1980
SPEI_end <- 2012

```


## Climate Futures (MACA)
```{r Climate-Futures, message=FALSE, warning=FALSE, include=FALSE, results=HIDE}

if(centroids_csv == "Y") {
  source(here::here("scripts", "Climate-Futures", "download_Tercek_csvs.R"), local = knitr::knit_global())
} else {
  print("Other data needed")
  #source(here::here("scripts", "Climate-Futures", "CFT_CF_parsing_v1.R")) # Parse MACA data. Output = "_init_parsed.RData". # 9-8-21: CFT parsing script is not working due to an issue with the package or MACA servers. ACR to talk to CU Boulder about the issue. For now, add _init_parsed.RData file manually to parsed-data folder. 
}

source(here::here("scripts", "Climate-Futures", "RSS_MACA_Plot_Table_Creation.R"), local = knitr::knit_global()) # Requires "PARK_init_parsed.RData"; Output = "PARK_lat_long_Final_Environment.RData". 

source(here::here("scripts", "Climate-Futures", "Plotting_Functions.R"), local = knitr::knit_global())


source(here::here("scripts", "Climate-Futures", "RSS_MACA_Scatter and diagnostic.R"), local = knitr::knit_global()) # Creates scatter and diagnostic plots. Outputs to Figs MACA folder. 
```

## WW/HD CFs

```{r WarmWet/HotDry, message=FALSE, warning=FALSE, include=FALSE, results=HIDE}
# Specify Climate Futures

FutureSubset <- c("Warm Wet","Hot Dry"); CFs = FutureSubset  # Pick pair of climate futures.
# WB_GCMs <- subset(WB_GCMs, CF %in% CFs)

colors2<- c("slateblue2", "red3") # Select pair of climate futures - WarmWet/HotDry
#colors2<- c("#F3D3CB","#12045C")  # Select pair of climate futures - HotWet/WarmDry

colors3<-c("white",colors2)
col<- c("darkgray",colors2)  # WarmWet/HotDry
#col<- c("darkgray","#F3D3CB","#12045C")  # HotWet/WarmDry

CFDir = paste0(OutDir,"WarmWet_HotDry/") # for .csv's
if(dir.exists(CFDir) == FALSE){
  dir.create(CFDir)
}

TableDir = paste0(CFDir,"tables/") # for .csv's
if(dir.exists(TableDir) == FALSE){
  dir.create(TableDir)
}

FigDir = paste0(CFDir,"figures/") # for .csv's
if(dir.exists(FigDir) == FALSE){
  dir.create(FigDir)
}

if (exists("FutureSubset") == FALSE) stop("Please specify Climate Futures") # At the top of the script, please enter a combination of futures, e.g. Warm Wet/Hot Dry

source(here::here("scripts", "Climate-Futures", "RSS_Plotting_Bar_Charts.R")) # Requires "PARK_lat_long_Final_Environment.RData". Outputs plots and Excel Workbook 

source(here::here("scripts", "Additional-tables-plots", "RSS_MACA_drought_char.R"))

source(here::here("scripts", "Additional-tables-plots", "Return_Events.R"))

source(here::here("scripts", "WaterBalance", "WBgrid_plotting.R")) # Run the Water Balance Model

source(here::here("scripts", "SummaryPlots", "Summary plots.R"))

source(here::here("scripts", "Misc", "Report_plots.R"))

```



## WW/HD CFs

```{r WarmWet/HotDry, message=FALSE, warning=FALSE, include=FALSE, results=HIDE}
# Specify Climate Futures

FutureSubset <- c("Warm Dry","Hot Wet"); CFs = FutureSubset  # Pick pair of climate futures.

# WB_GCMs <- subset(WB_GCMs, CF %in% CFs)

# colors2<- c("#9A9EE5","#E10720")  # Select pair of climate futures - WarmWet/HotDry
colors2<- c("green4", "gold1") # Select pair of climate futures - HotWet/WarmDry

colors3<-c("white",colors2)
# col<- c("darkgray","#9A9EE5","#E10720")  # WarmWet/HotDry
col<- c("darkgray", colors2)  # HotWet/WarmDry

CFDir = paste0(OutDir,"WarmDry_HotWet/") # for .csv's
if(dir.exists(CFDir) == FALSE){
  dir.create(CFDir)
}

TableDir = paste0(CFDir,"tables/") # for .csv's
if(dir.exists(TableDir) == FALSE){
  dir.create(TableDir)
}

FigDir = paste0(CFDir,"figures/") # for .csv's
if(dir.exists(FigDir) == FALSE){
  dir.create(FigDir)
}

if (exists("FutureSubset") == FALSE) stop("Please specify Climate Futures") # At the top of the script, please enter a combination of futures, e.g. Warm Wet/Hot Dry

source(here::here("scripts", "Climate-Futures", "RSS_Plotting_Bar_Charts.R")) # Requires "PARK_lat_long_Final_Environment.RData". Outputs plots and Excel Workbook 

source(here::here("scripts", "Additional-tables-plots", "RSS_MACA_drought_char.R"))

source(here::here("scripts", "Additional-tables-plots", "Return_Events.R"))

source(here::here("scripts", "WaterBalance", "WBgrid_plotting.R")) # Run the Water Balance Model

source(here::here("scripts", "SummaryPlots", "Summary plots.R"))

source(here::here("scripts", "Misc", "Report_plots.R"))

```



# Create metadata and copy/delete files

```{r Copy-and-delete-files, message=FALSE, warning=FALSE}

# This script is for copying and pasting files and folders unique to an RSS to a local folder, for the purposes of using, sharing, or archiving products. Files are then deleted from the Climate_Futures repo so that files are not inadvertently overwritten or confused with products from a different site.


source(here::here("scripts", "Misc", "write_metadata.R"))

source(here::here("scripts", "Misc", "copy_paste_delete_files.R")) # copies files and folders to specified local folder


```



